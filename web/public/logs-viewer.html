<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á≠ñÁï•Êó•Âøó‰ª™Ë°®Áõò - DLMMÊµÅÂä®ÊÄßÁÆ°ÁêÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard {
            display: flex;
            height: 100vh;
        }

        /* Â∑¶‰æßÊ†è - Á≠ñÁï•ÂÆû‰æãÂàóË°® */
        .sidebar {
            width: 320px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .sidebar-stats {
            padding: 15px 20px;
            background: rgba(59, 130, 246, 0.15);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stats-item:last-child {
            margin-bottom: 0;
        }

        .stats-label {
            color: #94a3b8;
        }

        .stats-value {
            font-weight: 600;
            color: #60a5fa;
        }

        .instance-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .instance-item {
            margin-bottom: 8px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(51, 65, 85, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .instance-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            background: rgba(71, 85, 105, 0.9);
        }

        .instance-item.active {
            border-color: #60a5fa;
            box-shadow: 0 4px 16px rgba(96, 165, 250, 0.4);
            background: rgba(59, 130, 246, 0.2);
        }

        .instance-header {
            padding: 12px 15px;
            background: rgba(30, 41, 59, 0.5);
        }

        .instance-id {
            font-weight: 600;
            font-size: 13px;
            color: #e2e8f0;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .instance-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #94a3b8;
        }

        .instance-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
        }

        /* Á≥ªÁªüÊó•ÂøóÂíåÁ≠ñÁï•Êó•ÂøóÁöÑÂå∫Âà´Ê†∑Âºè */
        .instance-item.system-log {
            border-left: 3px solid #f59e0b;
        }

        .instance-item.system-log .status-dot {
            background: #f59e0b;
        }

        .instance-item.system-log:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        .instance-item.system-log.active {
            border-color: #f59e0b;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
            background: rgba(245, 158, 11, 0.2);
        }

        .instance-item.strategy-log {
            border-left: 3px solid transparent;
        }

        /* üîß ÁÆÄÂçïYÁ≠ñÁï•Ê†∑Âºè */
        .instance-item.simple-y-log {
            border-left: 3px solid #10b981;
        }

        .instance-item.simple-y-log .status-dot {
            background: #10b981;
        }

        .instance-item.simple-y-log:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        .instance-item.simple-y-log.active {
            border-color: #10b981;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
            background: rgba(16, 185, 129, 0.2);
        }

        /* üîß ËøûÈîÅÂ§¥ÂØ∏Á≠ñÁï•Ê†∑Âºè */
        .instance-item.chain-position-log {
            border-left: 3px solid #3b82f6;
        }

        .instance-item.chain-position-log .status-dot {
            background: #3b82f6;
        }

        .instance-item.chain-position-log:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .instance-item.chain-position-log.active {
            border-color: #3b82f6;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            background: rgba(59, 130, 246, 0.2);
        }

        /* Âè≥‰æß‰∏ªÂÜÖÂÆπÂå∫ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
        }

        .main-header {
            padding: 20px 30px;
            background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .main-title {
            font-size: 24px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .main-subtitle {
            color: #94a3b8;
            font-size: 14px;
        }

        .log-controls {
            padding: 15px 30px;
            background: rgba(51, 65, 85, 0.8);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-label {
            font-size: 14px;
            color: #e2e8f0;
            font-weight: 500;
        }

        .control-input {
            padding: 6px 12px;
            border: 1px solid #475569;
            border-radius: 4px;
            font-size: 14px;
            background: rgba(30, 41, 59, 0.8);
            color: #e2e8f0;
            transition: all 0.3s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }

        .control-input::placeholder {
            color: #94a3b8;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-filter-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-filter-active:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .log-container {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #f8f8f2;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .log-line {
            margin-bottom: 2px;
            padding: 4px 8px;
            border-radius: 3px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-line:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .log-timestamp {
            color: #8be9fd;
            margin-right: 8px;
        }

        .log-level {
            margin-right: 8px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .log-info .log-level {
            background: #50fa7b;
            color: #282a36;
        }

        .log-warn .log-level {
            background: #ffb86c;
            color: #282a36;
        }

        .log-error .log-level {
            background: #ff5555;
            color: white;
        }

        .log-debug .log-level {
            background: #bd93f9;
            color: white;
        }

        .log-message {
            color: #f8f8f2;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #94a3b8;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        .empty-state p {
            font-size: 14px;
            text-align: center;
            max-width: 300px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            color: #94a3b8;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #334155;
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #f87171;
            text-align: center;
            padding: 20px;
        }

        .error-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #60a5fa;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(96, 165, 250, 0.6);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(96, 165, 250, 0.8);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
            }

            .instance-list {
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 10px;
            }

            .instance-item {
                min-width: 200px;
                margin-right: 8px;
                margin-bottom: 0;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Â∑¶‰æßÊ†è - Á≠ñÁï•ÂÆû‰æãÂàóË°® -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üéØ Á≠ñÁï•ÂÆû‰æã</h1>
                <div class="subtitle">Strategy Instances</div>
            </div>

            <div class="sidebar-stats">
                <div class="stats-item">
                    <span class="stats-label">ÊÄªÂÆû‰æãÊï∞</span>
                    <span class="stats-value" id="totalInstances">-</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Ê¥ªË∑ÉÂÆû‰æã</span>
                    <span class="stats-value" id="activeInstances">-</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">ÊúÄÂêéÊõ¥Êñ∞</span>
                    <span class="stats-value" id="lastUpdate">-</span>
                </div>
            </div>

            <div class="instance-list" id="instanceList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Ê≠£Âú®Âä†ËΩΩÁ≠ñÁï•ÂÆû‰æã...</p>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æß‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <div class="main-header">
                <div class="main-title" id="mainTitle">Á≠ñÁï•Êó•Âøó‰ª™Ë°®Áõò</div>
                <div class="main-subtitle" id="mainSubtitle">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Á≠ñÁï•ÂÆû‰æãÊü•ÁúãÊó•Âøó</div>
            </div>

            <div class="log-controls">
                <div class="control-group">
                    <label class="control-label">ÊòæÁ§∫Ë°åÊï∞:</label>
                    <select class="control-input" id="linesSelect">
                        <option value="50">50Ë°å</option>
                        <option value="100">100Ë°å</option>
                        <option value="200">200Ë°å</option>
                        <option value="500" selected>500Ë°å</option>
                        <option value="1000">1000Ë°å</option>
                    </select>
                </div>

                <div class="control-group auto-refresh">
                    <label class="control-label">Ëá™Âä®Âà∑Êñ∞:</label>
                    <label class="switch">
                        <input type="checkbox" id="autoRefresh">
                        <span class="slider"></span>
                    </label>
                </div>

                <button class="btn btn-primary" id="refreshBtn">
                    üîÑ Âà∑Êñ∞Êó•Âøó
                </button>

                <button class="btn btn-secondary" id="clearBtn">
                    üóëÔ∏è Ê∏ÖÁ©∫ÊòæÁ§∫
                </button>

                <div class="control-group">
                    <label class="control-label">Á≠õÈÄâ:</label>
                    <input type="text" class="control-input" id="filterInput" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÁ≠õÈÄâÊó•Âøó..."
                        style="width: 200px;">
                </div>

                <button class="btn btn-primary" id="filterBtn">
                    üîç Á≠õÈÄâ
                </button>

                <button class="btn btn-secondary" id="clearFilterBtn" style="display: none;">
                    üîÑ ÊÅ¢Â§çÈªòËÆ§
                </button>

                <button class="btn btn-secondary" id="showAllBtn" style="display: none;">
                    üìÑ ÊòæÁ§∫ÂÖ®ÈÉ®
                </button>
            </div>

            <div class="log-container" id="logContainer">
                <div class="empty-state">
                    <div class="icon">üìã</div>
                    <h3>ÈÄâÊã©Á≠ñÁï•ÂÆû‰æã</h3>
                    <p>ËØ∑‰ªéÂ∑¶‰æßÊ†èÈÄâÊã©‰∏Ä‰∏™Á≠ñÁï•ÂÆû‰æãÊù•Êü•ÁúãÂÖ∂Êó•ÂøóËÆ∞ÂΩï</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LogsDashboard {
            constructor() {
                this.apiBaseUrl = '/api';
                this.instances = [];
                this.selectedInstance = null;
                this.autoRefreshInterval = null;
                this.isLoading = false;
                this.currentLogs = []; // Â≠òÂÇ®ÂΩìÂâçÂä†ËΩΩÁöÑÊâÄÊúâÊó•Âøó
                this.filteredLogs = []; // Â≠òÂÇ®Á≠õÈÄâÂêéÁöÑÊó•Âøó
                this.currentFilter = ''; // ÂΩìÂâçÁ≠õÈÄâÂÖ≥ÈîÆËØç
                this.isFiltered = false; // ÂàùÂßã‰∏çÂêØÁî®Á≠õÈÄâÁä∂ÊÄÅ

                this.initializeElements();
                this.bindEvents();
                this.loadInstances();
            }

            initializeElements() {
                this.elements = {
                    instanceList: document.getElementById('instanceList'),
                    logContainer: document.getElementById('logContainer'),
                    mainTitle: document.getElementById('mainTitle'),
                    mainSubtitle: document.getElementById('mainSubtitle'),
                    totalInstances: document.getElementById('totalInstances'),
                    activeInstances: document.getElementById('activeInstances'),
                    lastUpdate: document.getElementById('lastUpdate'),
                    linesSelect: document.getElementById('linesSelect'),
                    autoRefresh: document.getElementById('autoRefresh'),
                    refreshBtn: document.getElementById('refreshBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    filterInput: document.getElementById('filterInput'),
                    filterBtn: document.getElementById('filterBtn'),
                    clearFilterBtn: document.getElementById('clearFilterBtn'),
                    showAllBtn: document.getElementById('showAllBtn')
                };
            }

            bindEvents() {
                this.elements.refreshBtn.addEventListener('click', () => {
                    if (this.selectedInstance) {
                        this.loadInstanceLogs(this.selectedInstance);
                    } else {
                        this.loadInstances();
                    }
                });

                this.elements.clearBtn.addEventListener('click', () => {
                    this.clearLogDisplay();
                });

                this.elements.autoRefresh.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                });

                this.elements.linesSelect.addEventListener('change', () => {
                    if (this.selectedInstance) {
                        this.loadInstanceLogs(this.selectedInstance);
                    }
                });

                this.elements.filterBtn.addEventListener('click', () => {
                    this.applyFilter();
                });

                this.elements.clearFilterBtn.addEventListener('click', () => {
                    this.clearFilter();
                });

                this.elements.filterInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.applyFilter();
                    }
                });

                this.elements.showAllBtn.addEventListener('click', () => {
                    this.showAllLogs();
                });
            }

            async loadInstances() {
                try {
                    this.showInstancesLoading();

                    const response = await fetch(`${this.apiBaseUrl}/logs/instances`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Ëé∑ÂèñÂÆû‰æãÂàóË°®Â§±Ë¥•');
                    }

                    this.instances = data.instances;
                    this.renderInstances();
                    this.updateStats();

                } catch (error) {
                    console.error('Âä†ËΩΩÂÆû‰æãÂàóË°®Â§±Ë¥•:', error);
                    this.showInstancesError(error.message);
                }
            }

            showInstancesLoading() {
                this.elements.instanceList.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Ê≠£Âú®Âä†ËΩΩÁ≠ñÁï•ÂÆû‰æã...</p>
                    </div>
                `;
            }

            showInstancesError(message) {
                this.elements.instanceList.innerHTML = `
                    <div class="error-state">
                        <div class="icon">‚ùå</div>
                        <h3>Âä†ËΩΩÂ§±Ë¥•</h3>
                        <p>${message}</p>
                    </div>
                `;
            }

            renderInstances() {
                if (this.instances.length === 0) {
                    this.elements.instanceList.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìÇ</div>
                            <h3>Êú™ÊâæÂà∞Á≠ñÁï•ÂÆû‰æã</h3>
                            <p>ËØ∑Á°Æ‰øùÁ≠ñÁï•Ê≠£Âú®ËøêË°åÂπ∂ÁîüÊàêÊó•ÂøóÊñá‰ª∂</p>
                        </div>
                    `;
                    return;
                }

                const instancesHtml = this.instances.map(instance => {
                    const isActive = this.selectedInstance === instance.instanceId;
                    let displayName, icon, statusText, statusClass;

                    if (instance.instanceId === 'api-server') {
                        // APIÊúçÂä°Âô®Êó•Âøó
                        displayName = 'üñ•Ô∏è APIÊúçÂä°Âô®';
                        icon = 'üñ•Ô∏è';
                        statusText = 'Á≥ªÁªü';
                        statusClass = 'system-log';
                    } else {
                        // Á≠ñÁï•ÂÆû‰æãÊó•Âøó
                        const shortId = this.formatInstanceId(instance.instanceId);
                        
                        // üîß Ê†πÊçÆÁ≠ñÁï•Á±ªÂûãËÆæÁΩÆÊòæÁ§∫ÂêçÁß∞ÂíåÂõæÊ†á
                        if (instance.strategyType === 'simple-y' || instance.instanceId.includes('simple-y_')) {
                            const strategyName = instance.strategyName || 'Êú™ÂëΩÂêç';
                            displayName = `üéØ ÁÆÄÂçïYÁ≠ñÁï• ${strategyName} ${shortId}`;
                            icon = 'üéØ';
                            statusText = 'Ê¥ªË∑É';
                            statusClass = 'strategy-log simple-y-log';
                        } else {
                            const strategyName = instance.strategyName || 'Êú™ÂëΩÂêç';
                            displayName = `üîó ËøûÈîÅÂ§¥ÂØ∏ ${strategyName} ${shortId}`;
                            icon = 'üîó';
                            statusText = 'Ê¥ªË∑É';
                            statusClass = 'strategy-log chain-position-log';
                        }
                    }

                    return `
                        <div class="instance-item ${isActive ? 'active' : ''} ${statusClass}" 
                             data-instance-id="${instance.instanceId}">
                            <div class="instance-header">
                                <div class="instance-id">${displayName}</div>
                                <div class="instance-meta">
                                    <div class="instance-status">
                                        <div class="status-dot"></div>
                                        <span>${statusText}</span>
                                    </div>
                                    <span>${this.formatFileSize(instance.size)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                this.elements.instanceList.innerHTML = instancesHtml;

                // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
                this.elements.instanceList.querySelectorAll('.instance-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const instanceId = item.dataset.instanceId;
                        this.selectInstance(instanceId);
                    });
                });
            }

            formatInstanceId(instanceId) {
                // Âè™ÊòæÁ§∫Êú´Â∞æÁöÑÁÆÄÂåñIDÔºåÈÄöÂ∏∏ÊòØ‰∏ãÂàíÁ∫øÂêéÁöÑÁü≠ID
                const parts = instanceId.split('_');
                if (parts.length >= 3) {
                    // ËøîÂõûÊúÄÂêé‰∏ÄÈÉ®ÂàÜ‰Ωú‰∏∫ÁÆÄÂåñID (‰æãÂ¶Ç: tk93bn)
                    return parts[parts.length - 1];
                }
                // Â¶ÇÊûúÊ†ºÂºè‰∏çÁ¨¶ÂêàÈ¢ÑÊúüÔºåËøîÂõûÊúÄÂêé8‰∏™Â≠óÁ¨¶
                return instanceId.length > 8 ? instanceId.substring(instanceId.length - 8) : instanceId;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            selectInstance(instanceId) {
                // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
                this.selectedInstance = instanceId;

                // Êõ¥Êñ∞UIÈÄâ‰∏≠Áä∂ÊÄÅ
                this.elements.instanceList.querySelectorAll('.instance-item').forEach(item => {
                    item.classList.remove('active');
                });

                const selectedItem = this.elements.instanceList.querySelector(`[data-instance-id="${instanceId}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }

                // Êõ¥Êñ∞Ê†áÈ¢ò
                const instance = this.instances.find(inst => inst.instanceId === instanceId);
                let titleText, subtitleText;

                if (instanceId === 'api-server') {
                    // APIÊúçÂä°Âô®Êó•Âøó
                    titleText = `üñ•Ô∏è APIÊúçÂä°Âô®Êó•Âøó`;
                    subtitleText = `Á≥ªÁªüËøêË°åÊó•Âøó - ÂÆûÊó∂ÁõëÊéß`;
                } else {
                    // Á≠ñÁï•ÂÆû‰æãÊó•Âøó
                    const shortId = this.formatInstanceId(instanceId);
                    
                    // üîß Ê†πÊçÆÁ≠ñÁï•Á±ªÂûãËÆæÁΩÆÊòæÁ§∫Ê†áÈ¢ò
                    if (instance?.strategyType === 'simple-y' || instanceId.includes('simple-y_')) {
                        const strategyName = instance?.strategyName || 'Êú™ÂëΩÂêç';
                        titleText = `üéØ ÁÆÄÂçïYÁ≠ñÁï• ${strategyName} ${shortId}`;
                        subtitleText = `ÁÆÄÂçïYÂ§¥ÂØ∏Á≠ñÁï•ÂÆû‰æãÊó•Âøó - ÂÆûÊó∂ÁõëÊéß`;
                    } else {
                        const strategyName = instance?.strategyName || 'Êú™ÂëΩÂêç';
                        titleText = `üîó ËøûÈîÅÂ§¥ÂØ∏ ${strategyName} ${shortId}`;
                        subtitleText = `ËøûÈîÅÂ§¥ÂØ∏Á≠ñÁï•ÂÆû‰æãÊó•Âøó - ÂÆûÊó∂ÁõëÊéß`;
                    }
                }

                this.elements.mainTitle.textContent = titleText;
                this.elements.mainSubtitle.textContent = subtitleText;

                // Âä†ËΩΩÊó•Âøó
                this.loadInstanceLogs(instanceId);
            }

            async loadInstanceLogs(instanceId) {
                if (this.isLoading) return;

                try {
                    this.isLoading = true;
                    this.showLogLoading();

                    const lines = this.elements.linesSelect.value;
                    const response = await fetch(`${this.apiBaseUrl}/logs/${instanceId}?lines=${lines}`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•');
                    }

                    this.renderLogs(data.logs);
                    this.updateLogStats(data);

                } catch (error) {
                    console.error('Âä†ËΩΩÊó•ÂøóÂ§±Ë¥•:', error);
                    this.showLogError(error.message);
                } finally {
                    this.isLoading = false;
                }
            }

            showLogLoading() {
                this.elements.logContainer.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Ê≠£Âú®Âä†ËΩΩÊó•Âøó...</p>
                    </div>
                `;
            }

            showLogError(message) {
                this.elements.logContainer.innerHTML = `
                    <div class="error-state">
                        <div class="icon">‚ùå</div>
                        <h3>Âä†ËΩΩÊó•ÂøóÂ§±Ë¥•</h3>
                        <p>${message}</p>
                    </div>
                `;
            }

            renderLogs(logs) {
                // Â≠òÂÇ®ÂΩìÂâçÂä†ËΩΩÁöÑÊó•Âøó
                this.currentLogs = logs;

                // Â¶ÇÊûúÊ≠£Âú®Á≠õÈÄâÁä∂ÊÄÅÔºåÂ∫îÁî®Á≠õÈÄâ
                if (this.isFiltered) {
                    this.filteredLogs = this.filterLogs(logs, this.currentFilter);
                    this.displayLogs(this.filteredLogs);
                } else {
                    this.displayLogs(logs);
                }
            }

            displayLogs(logs) {
                if (logs.length === 0) {
                    const emptyMessage = this.isFiltered ?
                        `<div class="empty-state">
                            <div class="icon">üîç</div>
                            <h3>Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊó•Âøó</h3>
                            <p>Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´ "${this.currentFilter}" ÁöÑÊó•ÂøóËÆ∞ÂΩï</p>
                        </div>` :
                        `<div class="empty-state">
                            <div class="icon">üìÑ</div>
                            <h3>ÊöÇÊó†Êó•ÂøóÊï∞ÊçÆ</h3>
                            <p>ËØ•Á≠ñÁï•ÂÆû‰æãÂ∞öÊú™ÁîüÊàêÊó•ÂøóËÆ∞ÂΩï</p>
                        </div>`;

                    this.elements.logContainer.innerHTML = emptyMessage;
                    return;
                }

                const logsHtml = logs.map(line => {
                    const parsed = this.parseLogLine(line);
                    const levelClass = this.getLogLevelClass(parsed.level);

                    return `
                        <div class="log-line ${levelClass}">
                            <span class="log-timestamp">${parsed.timestamp}</span>
                            <span class="log-level">[${parsed.level}]</span>
                            <span class="log-message">${this.escapeHtml(parsed.message)}</span>
                        </div>
                    `;
                }).join('');

                this.elements.logContainer.innerHTML = logsHtml;

                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                this.elements.logContainer.scrollTop = this.elements.logContainer.scrollHeight;
            }

            parseLogLine(line) {
                // Ëß£ÊûêÊó•ÂøóÊ†ºÂºè: 06/24 09:06:49 INFO [strategy-xxx] OP: message
                const match = line.match(/^(\d{2}\/\d{2} \d{2}:\d{2}:\d{2})\s+(\w+)\s+\[([^\]]+)\]\s+(.+)$/);

                if (match) {
                    return {
                        timestamp: match[1],
                        level: match[2],
                        component: match[3],
                        message: match[4]
                    };
                }

                return {
                    timestamp: '',
                    level: 'INFO',
                    component: '',
                    message: line
                };
            }

            getLogLevelClass(level) {
                switch (level?.toUpperCase()) {
                    case 'ERROR': return 'log-error';
                    case 'WARN': case 'WARNING': return 'log-warn';
                    case 'DEBUG': return 'log-debug';
                    case 'INFO': default: return 'log-info';
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateStats() {
                // ËÆ°ÁÆóÁ≠ñÁï•ÂÆû‰æãÊï∞ÈáèÔºàÊéíÈô§APIÊúçÂä°Âô®Ôºâ
                const strategyInstances = this.instances.filter(inst => inst.instanceId !== 'api-server');

                this.elements.totalInstances.textContent = strategyInstances.length;
                this.elements.activeInstances.textContent = strategyInstances.length;
                this.elements.lastUpdate.textContent = new Date().toLocaleTimeString();
            }

            updateLogStats(data) {
                const instance = this.instances.find(inst => inst.instanceId === data.instanceId);
                let displayName;

                if (data.instanceId === 'api-server') {
                    // APIÊúçÂä°Âô®Êó•Âøó
                    displayName = 'APIÊúçÂä°Âô®';
                } else {
                    // Á≠ñÁï•ÂÆû‰æãÊó•Âøó
                    const shortId = this.formatInstanceId(data.instanceId);
                    
                    // üîß Ê†πÊçÆÁ≠ñÁï•Á±ªÂûãËÆæÁΩÆÊòæÁ§∫ÂêçÁß∞
                    if (instance?.strategyType === 'simple-y' || data.instanceId.includes('simple-y_')) {
                        const strategyName = instance?.strategyName || 'Êú™ÂëΩÂêç';
                        displayName = `ÁÆÄÂçïYÁ≠ñÁï• ${strategyName} ${shortId}`;
                    } else {
                        const strategyName = instance?.strategyName || 'Êú™ÂëΩÂêç';
                        displayName = `ËøûÈîÅÂ§¥ÂØ∏ ${strategyName} ${shortId}`;
                    }
                }

                this.elements.mainSubtitle.textContent =
                    `${displayName} ‚Ä¢ ÊòæÁ§∫ÊúÄÊñ∞ ${data.logs.length}/${data.totalLines} Ë°å ‚Ä¢ Êñá‰ª∂Â§ßÂ∞è ${this.formatFileSize(data.fileSize)}`;
            }

            clearLogDisplay() {
                // Ê∏ÖÁ©∫Êó•ÂøóÊï∞ÊçÆ
                this.currentLogs = [];
                this.filteredLogs = [];

                // ‰øùÊåÅÁ≠õÈÄâÁä∂ÊÄÅ‰ΩÜÊ∏ÖÁ©∫ÊòæÁ§∫
                this.elements.logContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üßπ</div>
                        <h3>ÊòæÁ§∫Â∑≤Ê∏ÖÁ©∫</h3>
                        <p>ÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆÈáçÊñ∞Âä†ËΩΩÊó•Âøó</p>
                    </div>
                `;
            }

            startAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                }

                this.autoRefreshInterval = setInterval(() => {
                    if (this.selectedInstance && !this.isLoading) {
                        this.loadInstanceLogs(this.selectedInstance);
                    }
                }, 5000); // ÊØè5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
            }

            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            }

            applyFilter() {
                let filterText = this.elements.filterInput.value.trim();

                // Â¶ÇÊûúËæìÂÖ•‰∏∫Á©∫ÔºåÊ†πÊçÆÊó•ÂøóÁ±ªÂûã‰ΩøÁî®ÈªòËÆ§Á≠õÈÄâÊù°‰ª∂
                if (!filterText) {
                    if (this.selectedInstance === 'api-server') {
                        filterText = 'INFO'; // APIÊúçÂä°Âô®Êó•ÂøóÈªòËÆ§Á≠õÈÄâINFOÁ∫ßÂà´
                    } else if (this.selectedInstance && this.selectedInstance.includes('simple-y_')) {
                        // üîß ÁÆÄÂçïYÁ≠ñÁï•ÁöÑÈªòËÆ§Á≠õÈÄâÊù°‰ª∂
                        filterText = 'ÁÆÄÂçïY'; // Á≠õÈÄâÂåÖÂê´"ÁÆÄÂçïY"ÁöÑÊó•Âøó
                    } else {
                        // ËøûÈîÅÂ§¥ÂØ∏Á≠ñÁï•ÈªòËÆ§Á≠õÈÄâÊù°‰ª∂
                        filterText = 'Â§¥ÂØ∏ÈáçÂª∫Ëß¶Âèë';
                    }
                    this.elements.filterInput.value = filterText;
                }

                if (this.currentLogs.length === 0) {
                    this.showFilterError('ËØ∑ÂÖàÂä†ËΩΩÊó•ÂøóÊï∞ÊçÆ');
                    return;
                }

                this.currentFilter = filterText;
                this.isFiltered = true;

                // Á≠õÈÄâÊó•Âøó
                this.filteredLogs = this.filterLogs(this.currentLogs, filterText);

                // ÊòæÁ§∫Á≠õÈÄâÁªìÊûú
                this.displayLogs(this.filteredLogs);

                // Êõ¥Êñ∞UIÁä∂ÊÄÅ
                this.updateFilterUI();

                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                this.updateFilterStats();
            }

            clearFilter() {
                // Ê†πÊçÆÊó•ÂøóÁ±ªÂûãÊÅ¢Â§çÂà∞ÈªòËÆ§Á≠õÈÄâÁä∂ÊÄÅ
                let defaultFilter;
                if (this.selectedInstance === 'api-server') {
                    defaultFilter = 'INFO'; // APIÊúçÂä°Âô®Êó•ÂøóÈªòËÆ§Á≠õÈÄâINFOÁ∫ßÂà´
                } else if (this.selectedInstance && this.selectedInstance.includes('simple-y_')) {
                    // üîß ÁÆÄÂçïYÁ≠ñÁï•ÁöÑÈªòËÆ§Á≠õÈÄâÊù°‰ª∂
                    defaultFilter = 'ÁÆÄÂçïY'; // Á≠õÈÄâÂåÖÂê´"ÁÆÄÂçïY"ÁöÑÊó•Âøó
                } else {
                    // ËøûÈîÅÂ§¥ÂØ∏Á≠ñÁï•ÈªòËÆ§Á≠õÈÄâÊù°‰ª∂
                    defaultFilter = 'Â§¥ÂØ∏ÈáçÂª∫Ëß¶Âèë';
                }

                this.currentFilter = defaultFilter;
                this.isFiltered = true;
                this.elements.filterInput.value = defaultFilter;

                // Â∫îÁî®ÈªòËÆ§Á≠õÈÄâ
                if (this.currentLogs.length > 0) {
                    this.filteredLogs = this.filterLogs(this.currentLogs, this.currentFilter);
                    this.displayLogs(this.filteredLogs);
                    this.updateFilterStats();
                } else {
                    this.displayLogs([]);
                }

                // Êõ¥Êñ∞UIÁä∂ÊÄÅ
                this.updateFilterUI();
            }

            filterLogs(logs, filterText) {
                if (!filterText) return logs;

                const lowerFilter = filterText.toLowerCase();
                return logs.filter(line =>
                    line.toLowerCase().includes(lowerFilter)
                );
            }

            updateFilterUI() {
                if (this.isFiltered) {
                    this.elements.filterBtn.style.display = 'none';
                    this.elements.clearFilterBtn.style.display = 'inline-block';
                    this.elements.showAllBtn.style.display = 'inline-block';
                    this.elements.clearFilterBtn.className = 'btn btn-danger';
                    this.elements.filterInput.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
                    this.elements.filterInput.style.borderColor = '#10b981';
                } else {
                    this.elements.filterBtn.style.display = 'inline-block';
                    this.elements.clearFilterBtn.style.display = 'none';
                    this.elements.showAllBtn.style.display = 'none';
                    this.elements.filterInput.style.backgroundColor = 'rgba(30, 41, 59, 0.8)';
                    this.elements.filterInput.style.borderColor = '#475569';
                }
            }

            updateFilterStats() {
                if (this.isFiltered) {
                    const totalLines = this.currentLogs.length;
                    const filteredLines = this.filteredLogs.length;

                    // Ëé∑ÂèñÂΩìÂâçÂÆû‰æãÁöÑÊòæÁ§∫ÂêçÁß∞
                    let instanceName = 'Êó•Âøó';
                    if (this.selectedInstance) {
                        const instance = this.instances.find(inst => inst.instanceId === this.selectedInstance);
                        if (this.selectedInstance === 'api-server') {
                            instanceName = 'APIÊúçÂä°Âô®';
                        } else {
                            const shortId = this.formatInstanceId(this.selectedInstance);
                            
                            // üîß Ê†πÊçÆÁ≠ñÁï•Á±ªÂûãËÆæÁΩÆÊòæÁ§∫ÂêçÁß∞
                            if (instance?.strategyType === 'simple-y' || this.selectedInstance.includes('simple-y_')) {
                                const strategyName = instance?.strategyName || 'Êú™ÂëΩÂêç';
                                instanceName = `ÁÆÄÂçïYÁ≠ñÁï• ${strategyName} ${shortId}`;
                            } else {
                                const strategyName = instance?.strategyName || 'Êú™ÂëΩÂêç';
                                instanceName = `ËøûÈîÅÂ§¥ÂØ∏ ${strategyName} ${shortId}`;
                            }
                        }
                    }

                    this.elements.mainSubtitle.textContent =
                        `${instanceName} ‚Ä¢ Á≠õÈÄâÁªìÊûú: ${filteredLines}/${totalLines} Êù°Êó•ÂøóÂåÖÂê´ "${this.currentFilter}"`;
                }
            }

            showAllLogs() {
                // ÂÖ≥Èó≠Á≠õÈÄâÔºåÊòæÁ§∫ÊâÄÊúâÊó•Âøó
                this.currentFilter = '';
                this.isFiltered = false;
                this.filteredLogs = [];
                this.elements.filterInput.value = '';

                // ÊòæÁ§∫ÊâÄÊúâÊó•Âøó
                this.displayLogs(this.currentLogs);

                // Êõ¥Êñ∞UIÁä∂ÊÄÅ
                this.updateFilterUI();

                // ÊÅ¢Â§çÁªüËÆ°‰ø°ÊÅØ
                this.updateLogStats({
                    logs: this.currentLogs,
                    totalLines: this.currentLogs.length,
                    instanceId: this.selectedInstance
                });
            }

            showFilterError(message) {
                // ‰∏¥Êó∂ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
                const originalPlaceholder = this.elements.filterInput.placeholder;
                this.elements.filterInput.placeholder = message;
                this.elements.filterInput.style.borderColor = '#ef4444';

                setTimeout(() => {
                    this.elements.filterInput.placeholder = originalPlaceholder;
                    this.elements.filterInput.style.borderColor = '#475569';
                }, 2000);
            }
        }

        // ÂàùÂßãÂåñ‰ª™Ë°®Áõò
        document.addEventListener('DOMContentLoaded', () => {
            new LogsDashboard();
        });
    </script>
</body>

</html>