<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”’ æ¨¡æ€æ¡†å…³é—­åŠŸèƒ½æµ‹è¯•</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background-color: #1a1b2e;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 2rem;
        }

        .test-card {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .log-area {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .btn-test {
            margin: 0.5rem;
            min-width: 120px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ok {
            background-color: #28a745;
        }

        .status-error {
            background-color: #dc3545;
        }

        .status-warning {
            background-color: #ffc107;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 class="text-center mb-4">ğŸ”’ æ¨¡æ€æ¡†å…³é—­åŠŸèƒ½æµ‹è¯•</h1>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="test-card">
            <h3 class="mb-3">ğŸ® æµ‹è¯•æ§åˆ¶</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary btn-test" onclick="initTest()">
                        ğŸš€ åˆå§‹åŒ–æµ‹è¯•
                    </button>
                    <button class="btn btn-success btn-test" onclick="showModal()" disabled id="show-btn">
                        ğŸ“ æ˜¾ç¤ºæ¨¡æ€æ¡†
                    </button>
                    <button class="btn btn-warning btn-test" onclick="testCloseButtons()">
                        ğŸ”’ æµ‹è¯•å…³é—­æŒ‰é’®
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-info btn-test" onclick="testEscKey()">
                        âŒ¨ï¸ æµ‹è¯•ESCé”®
                    </button>
                    <button class="btn btn-secondary btn-test" onclick="testBackdropClick()">
                        ğŸ–±ï¸ æµ‹è¯•èƒŒæ™¯ç‚¹å‡»
                    </button>
                    <button class="btn btn-danger btn-test" onclick="clearLog()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div class="test-card">
            <h3 class="mb-3">ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div class="row">
                <div class="col-md-4">
                    <p><span class="status-indicator status-error" id="modal-status"></span>æ¨¡æ€æ¡†çŠ¶æ€: <span
                            id="modal-text">æœªåˆå§‹åŒ–</span></p>
                </div>
                <div class="col-md-4">
                    <p><span class="status-indicator status-error" id="body-status"></span>BodyçŠ¶æ€: <span
                            id="body-text">æ­£å¸¸</span></p>
                </div>
                <div class="col-md-4">
                    <p><span class="status-indicator status-error" id="functions-status"></span>å…³é—­å‡½æ•°: <span
                            id="functions-text">æœªç»‘å®š</span></p>
                </div>
            </div>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="test-card">
            <h3 class="mb-3">ğŸ“œ å®æ—¶æ—¥å¿—</h3>
            <div class="log-area" id="log-area">
                ç­‰å¾…æµ‹è¯•å¼€å§‹...
            </div>
        </div>

        <!-- ç­–ç•¥ç®¡ç†å™¨å®¹å™¨ -->
        <div id="strategy-test-container" style="display: none;">
            <!-- ç­–ç•¥ç®¡ç†å™¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <!-- å¼•å…¥ä¿®å¤åçš„ç­–ç•¥æ¨¡å— -->
    <script src="../public/js/components/strategy/strategy-forms-simple.js"></script>
    <script src="../public/js/components/strategy/simple-y-manager.js"></script>

    <script>
        let testManager = null;
        let logMessages = [];
        let modalCheckInterval = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': '[INFO]',
                'success': '[SUCCESS]',
                'error': '[ERROR]',
                'warning': '[WARNING]'
            }[type] || '[INFO]';

            const logMessage = `${timestamp} ${prefix} ${message}`;
            logMessages.push(logMessage);

            const logArea = document.getElementById('log-area');
            logArea.innerHTML = logMessages.slice(-50).join('<br>');
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            logMessages = [];
            document.getElementById('log-area').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º...';
        }

        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus() {
            const modal = document.getElementById('create-simple-y-modal');
            const modalStatus = document.getElementById('modal-status');
            const modalText = document.getElementById('modal-text');
            const bodyStatus = document.getElementById('body-status');
            const bodyText = document.getElementById('body-text');
            const functionsStatus = document.getElementById('functions-status');
            const functionsText = document.getElementById('functions-text');

            // æ£€æŸ¥æ¨¡æ€æ¡†çŠ¶æ€
            if (modal) {
                const isVisible = modal.style.display === 'flex';
                modalStatus.className = `status-indicator ${isVisible ? 'status-ok' : 'status-error'}`;
                modalText.textContent = isVisible ? 'æ˜¾ç¤ºä¸­' : 'å·²éšè—';
            } else {
                modalStatus.className = 'status-indicator status-warning';
                modalText.textContent = 'ä¸å­˜åœ¨';
            }

            // æ£€æŸ¥bodyçŠ¶æ€
            const hasModalOpen = document.body.classList.contains('modal-open');
            const hasOverflowHidden = document.body.style.overflow === 'hidden';
            bodyStatus.className = `status-indicator ${hasModalOpen || hasOverflowHidden ? 'status-warning' : 'status-ok'}`;
            bodyText.textContent = hasModalOpen ? 'æ¨¡æ€æ¡†æ¨¡å¼' : 'æ­£å¸¸';

            // æ£€æŸ¥å…³é—­å‡½æ•°
            const hasCloseFunction = typeof window.closeSimpleYModal === 'function';
            functionsStatus.className = `status-indicator ${hasCloseFunction ? 'status-ok' : 'status-error'}`;
            functionsText.textContent = hasCloseFunction ? 'å·²ç»‘å®š' : 'æœªç»‘å®š';
        }

        // æµ‹è¯•å‡½æ•°
        async function initTest() {
            try {
                log('å¼€å§‹åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...', 'info');

                // æ£€æŸ¥ç±»æ˜¯å¦åŠ è½½
                if (!window.SimpleYStrategyManager || !window.SimpleYStrategyForms) {
                    throw new Error('ç­–ç•¥æ¨¡å—æœªæ­£ç¡®åŠ è½½');
                }
                log('ç­–ç•¥æ¨¡å—åŠ è½½æˆåŠŸ', 'success');

                // åˆ›å»ºç®¡ç†å™¨å®ä¾‹
                testManager = new SimpleYStrategyManager('strategy-test-container');
                const success = await testManager.init();

                if (success) {
                    log('ç­–ç•¥ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                    document.getElementById('show-btn').disabled = false;

                    // å¼€å§‹çŠ¶æ€ç›‘æ§
                    modalCheckInterval = setInterval(updateStatus, 500);
                    updateStatus();
                } else {
                    throw new Error('ç­–ç•¥ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥');
                }

            } catch (error) {
                log('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showModal() {
            try {
                log('å°è¯•æ˜¾ç¤ºæ¨¡æ€æ¡†...', 'info');
                if (testManager && testManager.forms) {
                    testManager.showCreateStrategyForm();
                    log('æ¨¡æ€æ¡†æ˜¾ç¤ºå‘½ä»¤å·²å‘é€', 'success');
                } else {
                    throw new Error('ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }
            } catch (error) {
                log('æ˜¾ç¤ºæ¨¡æ€æ¡†å¤±è´¥: ' + error.message, 'error');
            }
        }

        function testCloseButtons() {
            const modal = document.getElementById('create-simple-y-modal');
            if (!modal || modal.style.display !== 'flex') {
                log('è¯·å…ˆæ˜¾ç¤ºæ¨¡æ€æ¡†', 'warning');
                return;
            }

            log('æµ‹è¯•å…³é—­æŒ‰é’®...', 'info');

            // æ£€æŸ¥å…³é—­æŒ‰é’®
            const closeBtns = modal.querySelectorAll('button[onclick*="closeSimpleYModal"]');
            log(`æ‰¾åˆ° ${closeBtns.length} ä¸ªå…³é—­æŒ‰é’®`, 'info');

            if (closeBtns.length > 0) {
                log('æ¨¡æ‹Ÿç‚¹å‡»ç¬¬ä¸€ä¸ªå…³é—­æŒ‰é’®...', 'info');
                setTimeout(() => {
                    closeBtns[0].click();
                    log('å…³é—­æŒ‰é’®ç‚¹å‡»å®Œæˆ', 'success');
                }, 1000);
            } else {
                log('æœªæ‰¾åˆ°å…³é—­æŒ‰é’®', 'error');
            }
        }

        function testEscKey() {
            const modal = document.getElementById('create-simple-y-modal');
            if (!modal || modal.style.display !== 'flex') {
                log('è¯·å…ˆæ˜¾ç¤ºæ¨¡æ€æ¡†', 'warning');
                return;
            }

            log('æµ‹è¯•ESCé”®å…³é—­...', 'info');
            setTimeout(() => {
                const escEvent = new KeyboardEvent('keydown', { key: 'Escape' });
                document.dispatchEvent(escEvent);
                log('ESCé”®äº‹ä»¶å·²è§¦å‘', 'success');
            }, 1000);
        }

        function testBackdropClick() {
            const modal = document.getElementById('create-simple-y-modal');
            if (!modal || modal.style.display !== 'flex') {
                log('è¯·å…ˆæ˜¾ç¤ºæ¨¡æ€æ¡†', 'warning');
                return;
            }

            log('æµ‹è¯•èƒŒæ™¯ç‚¹å‡»å…³é—­...', 'info');
            setTimeout(() => {
                modal.click();
                log('èƒŒæ™¯ç‚¹å‡»äº‹ä»¶å·²è§¦å‘', 'success');
            }, 1000);
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function (e) {
            log('é¡µé¢é”™è¯¯: ' + e.message, 'error');
        });

        // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', function () {
            log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            updateStatus();
        });
    </script>
</body>

</html>