<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ ç­–ç•¥å¥åº·ç›‘æ§ | DLMMæµåŠ¨æ€§ç®¡ç†ç³»ç»Ÿ</title>

    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="css/health-monitor.css">
    <link rel="stylesheet" href="css/components.css">

    <style>
        body {
            margin: 0;
            background: #f8fafc;
            min-height: 100vh;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .navbar-brand {
            font-size: 20px;
            font-weight: 700;
            color: #374151;
            text-decoration: none;
        }

        .navbar-nav {
            display: flex;
            gap: 20px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .navbar-nav a {
            color: #6b7280;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .navbar-nav a:hover,
        .navbar-nav a.active {
            background: #f3f4f6;
            color: #374151;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            min-height: calc(100vh - 64px);
            padding: 20px 0;
        }

        /* æ¶ˆæ¯æç¤º */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .message.show {
            opacity: 1;
            transform: translateX(0);
        }

        .message.success {
            background: #10b981;
        }

        .message.error {
            background: #ef4444;
        }

        .message.warning {
            background: #f59e0b;
        }

        .message.info {
            background: #3b82f6;
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="index.html" class="navbar-brand">
                ğŸ¥ DLMM å¥åº·ç›‘æ§
            </a>
            <ul class="navbar-nav">
                <li><a href="index.html">ğŸ  é¦–é¡µ</a></li>
                <li><a href="strategy-monitor.html">ğŸ“Š ç­–ç•¥ç›‘æ§</a></li>
                <li><a href="health-monitor.html" class="active">ğŸ¥ å¥åº·ç›‘æ§</a></li>
                <li><a href="logs-viewer.html">ğŸ“„ æ—¥å¿—æŸ¥çœ‹</a></li>
                <li><a href="wallet-manager.html">ğŸ’° é’±åŒ…ç®¡ç†</a></li>
            </ul>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <div id="health-monitor-container"></div>
    </main>

    <!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
    <div id="message-container"></div>

    <!-- JavaScript ä¾èµ– -->
    <script src="js/services/api-service.js"></script>
    <script src="js/components/health/health-monitor.js"></script>

    <script>
        /**
         * ğŸ¥ å¥åº·ç›‘æ§é¡µé¢
         */
        class HealthMonitorPage {
            constructor() {
                this.healthMonitor = null;
                this.init();
            }

            /**
             * ğŸš€ åˆå§‹åŒ–é¡µé¢
             */
            init() {
                this.setupGlobalErrorHandling();
                this.initializeHealthMonitor();
                this.setupGlobalNotifications();

                console.log('ğŸ¥ å¥åº·ç›‘æ§é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }

            /**
             * ğŸ¥ åˆå§‹åŒ–å¥åº·ç›‘æ§å™¨
             */
            initializeHealthMonitor() {
                try {
                    this.healthMonitor = new HealthMonitor('health-monitor-container');

                    // é‡å†™æ˜¾ç¤ºæ¶ˆæ¯æ–¹æ³•ï¼Œä½¿ç”¨å…¨å±€é€šçŸ¥ç³»ç»Ÿ
                    this.healthMonitor.showSuccess = (message) => {
                        this.showMessage(message, 'success');
                    };

                    this.healthMonitor.showError = (message) => {
                        this.showMessage(message, 'error');
                    };

                    // æ·»åŠ å…¨å±€å¼•ç”¨ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œå…¶ä»–ç»„ä»¶è®¿é—®
                    window.healthMonitor = this.healthMonitor;

                } catch (error) {
                    console.error('âŒ å¥åº·ç›‘æ§å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showMessage('å¥åº·ç›‘æ§å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                }
            }

            /**
             * ğŸŒ è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
             */
            setupGlobalErrorHandling() {
                window.addEventListener('error', (event) => {
                    console.error('âŒ å…¨å±€é”™è¯¯:', event.error);
                    this.showMessage('å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', 'error');
                });

                window.addEventListener('unhandledrejection', (event) => {
                    console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                    this.showMessage('å¼‚æ­¥æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', 'error');
                });
            }

            /**
             * ğŸ”” è®¾ç½®å…¨å±€é€šçŸ¥ç³»ç»Ÿ
             */
            setupGlobalNotifications() {
                // æ‰©å±• APIClient æ¥æ˜¾ç¤ºç½‘ç»œé”™è¯¯
                if (window.APIClient) {
                    const originalRequest = APIClient.prototype.request;
                    APIClient.prototype.request = async function (method, url, data, options) {
                        try {
                            return await originalRequest.call(this, method, url, data, options);
                        } catch (error) {
                            if (error.message.includes('Network')) {
                                window.healthMonitorPage?.showMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                            }
                            throw error;
                        }
                    };
                }
            }

            /**
             * ğŸ”” æ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥
             */
            showMessage(message, type = 'info', duration = 5000) {
                const container = document.getElementById('message-container');

                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}`;
                messageElement.textContent = message;

                container.appendChild(messageElement);

                // æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    messageElement.classList.add('show');
                }, 10);

                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    messageElement.classList.remove('show');
                    setTimeout(() => {
                        if (messageElement.parentNode) {
                            messageElement.parentNode.removeChild(messageElement);
                        }
                    }, 300);
                }, duration);
            }

            /**
             * ğŸ§¹ é¡µé¢å¸è½½æ¸…ç†
             */
            cleanup() {
                if (this.healthMonitor) {
                    this.healthMonitor.destroy();
                    this.healthMonitor = null;
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.healthMonitorPage = new HealthMonitorPage();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (window.healthMonitorPage) {
                window.healthMonitorPage.cleanup();
            }
        });

        // ä¾¿æ·çš„å…¨å±€å‡½æ•°
        window.showMessage = function (message, type = 'info') {
            if (window.healthMonitorPage) {
                window.healthMonitorPage.showMessage(message, type);
            }
        };

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœè‡ªåŠ¨åˆ·æ–°
                if (window.healthMonitor && window.healthMonitor.autoRefresh) {
                    window.healthMonitor.toggleAutoRefresh();
                    window.healthMonitor._wasAutoRefreshingBeforeHidden = true;
                }
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤è‡ªåŠ¨åˆ·æ–°
                if (window.healthMonitor && window.healthMonitor._wasAutoRefreshingBeforeHidden) {
                    if (!window.healthMonitor.autoRefresh) {
                        window.healthMonitor.toggleAutoRefresh();
                    }
                    window.healthMonitor._wasAutoRefreshingBeforeHidden = false;

                    // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ•°æ®
                    window.healthMonitor.loadData();
                }
            }
        });
    </script>
</body>

</html>