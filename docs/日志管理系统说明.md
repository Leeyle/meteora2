# DLMM流动性管理系统 - 日志管理说明

## 概述

DLMM系统采用双层日志管理架构：
1. **内部日志系统**：基于LogWriter的结构化日志，支持自动轮转
2. **外部日志文件**：启动脚本输出的日志文件，需要手动管理

## 日志文件结构

```
logs/
├── api-server.log          # API服务器主日志 (外部)
├── web-server.log          # Web服务器主日志 (外部)
├── monitor-server.log      # 监控服务器日志 (外部)
├── system/                 # 系统层日志 (内部)
│   ├── system.log
│   └── system.error
├── business/               # 业务层日志 (内部)
│   ├── business-operations.log
│   ├── business-monitoring.log
│   └── business-*.error
├── strategies/             # 策略层日志 (内部)
│   └── instance-{ID}/
│       ├── operations/
│       └── monitoring/
├── errors/                 # 统一错误日志 (内部)
│   └── errors.error
└── misc/                   # 其他日志 (内部)
```

## 自动日志轮转

### 内部日志系统轮转
- **触发条件**：文件大小超过2MB
- **保留文件数**：3个 (current + .1 + .2)
- **轮转机制**：自动触发，无需人工干预

### 外部日志文件轮转
- **触发条件**：每30分钟检查一次
- **保留文件数**：3个
- **轮转机制**：守护进程自动执行

## 日志管理脚本

### 1. 自动轮转脚本
```bash
./scripts/log-rotator.sh
```
- 检查并轮转超过2MB的日志文件
- 清理7天前的过期日志
- 显示日志统计信息

### 2. 立即清理脚本
```bash
./scripts/clean-logs-now.sh
```
- 立即执行日志轮转
- 压缩主日志文件到最后1000行
- 清理临时文件和备份文件
- 交互式确认操作

### 3. 系统启动时的日志管理
```bash
./scripts/quick-start.sh
```
- 自动启动日志轮转守护进程
- 每30分钟检查一次日志文件大小
- 后台运行，不影响主服务

### 4. 系统停止时的清理
```bash
./scripts/quick-stop.sh
```
- 停止日志轮转守护进程
- 清理PID文件
- 可选择性清理日志文件

## 配置参数

### 日志轮转配置
```bash
# scripts/log-rotator.sh
MAX_SIZE_MB=2              # 最大文件大小(MB)
MAX_FILES=3                # 最大保留文件数
LOG_DIR="./logs"           # 日志目录
```

### 内部日志系统配置
```typescript
// src/types/logging.ts
export const DEFAULT_DEV_CONFIG: ILogConfig = {
    maxFileSize: 2 * 1024 * 1024, // 2MB
    maxFiles: 3,                   // 保留3个文件
    // ...
};
```

## 日志大小控制机制

### 双重保护
1. **预防性控制**：内部日志系统自动轮转
2. **兜底保护**：外部脚本定期检查和清理

### 轮转时机
- **内部系统**：写入时检查，超过2MB立即轮转
- **外部文件**：每30分钟检查一次
- **手动触发**：用户可随时执行清理脚本

### 文件命名规则
```
原文件: api-server.log
轮转后: api-server.log.1, api-server.log.2
最新的: api-server.log (新创建的空文件)
```

## 常用命令

### 查看日志大小
```bash
# 查看所有日志文件大小
ls -lh logs/

# 查看日志目录总大小
du -sh logs/

# 查看特定日志文件
tail -f logs/api-server.log
```

### 手动清理日志
```bash
# 立即清理所有日志
./scripts/clean-logs-now.sh

# 只执行轮转，不清理内容
./scripts/log-rotator.sh

# 完全重置日志 (慎用)
rm -rf logs && mkdir logs
```

### 监控日志增长
```bash
# 实时监控日志文件大小
watch -n 10 'ls -lh logs/*.log'

# 监控日志轮转守护进程
ps aux | grep log-rotator
```

## 故障排除

### 日志文件过大
```bash
# 立即清理
./scripts/clean-logs-now.sh

# 检查轮转守护进程是否运行
ps aux | grep log-rotator

# 手动启动轮转守护进程
nohup bash -c 'while true; do sleep 1800; ./scripts/log-rotator.sh >/dev/null 2>&1; done' &
```

### 日志轮转失败
```bash
# 检查文件权限
ls -la logs/

# 检查磁盘空间
df -h

# 手动执行轮转
./scripts/log-rotator.sh
```

### 守护进程管理
```bash
# 查看守护进程PID
cat .log-rotator.pid

# 停止守护进程
kill $(cat .log-rotator.pid)

# 重启守护进程
./scripts/quick-stop.sh && ./scripts/quick-start.sh
```

## 最佳实践

### 1. 定期监控
- 每周检查一次日志目录大小
- 监控日志轮转守护进程状态
- 关注异常的日志增长

### 2. 预防性维护
- 定期运行清理脚本
- 监控磁盘空间使用情况
- 备份重要的日志文件

### 3. 紧急处理
- 磁盘空间不足时立即执行清理
- 日志文件过大时手动轮转
- 系统异常时检查错误日志

## 技术细节

### 轮转机制
1. **检查文件大小**：使用`stat`命令获取文件大小
2. **文件移动**：按序号重命名现有文件
3. **创建新文件**：创建空的新日志文件
4. **删除旧文件**：删除超过保留数量的旧文件

### 守护进程
- **运行方式**：nohup + while循环
- **检查间隔**：30分钟 (1800秒)
- **错误处理**：静默执行，错误不影响主服务

### 安全性
- **权限检查**：确保有足够权限操作日志文件
- **原子操作**：文件移动和创建操作保证原子性
- **错误恢复**：单个文件轮转失败不影响其他文件

## 更新日志

### v2.0.0 (当前版本)
- ✅ 添加自动日志轮转守护进程
- ✅ 实现2MB大小限制
- ✅ 支持手动清理脚本
- ✅ 集成到启动/停止脚本
- ✅ 双层日志管理架构

### 计划功能
- 📋 日志压缩功能
- 📋 远程日志备份
- 📋 日志分析工具
- 📋 实时日志监控面板 