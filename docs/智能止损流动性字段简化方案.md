# æ™ºèƒ½æ­¢æŸæµåŠ¨æ€§å­—æ®µç®€åŒ–æ–¹æ¡ˆ (æ–¹æ¡ˆ3)

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

å°†é‡å çš„3ä¸ªæµåŠ¨æ€§å­—æ®µ(`inRangePercentage`, `liquidityHealth`, `activeBinDistance`)ç®€åŒ–ä¸ºæ ¸å¿ƒçš„binä½ç½®æ•°æ®ï¼Œç›´æ¥åœ¨æ™ºèƒ½æ­¢æŸæ¨¡å—ä¸­è¿›è¡Œé£é™©è®¡ç®—ã€‚

## ğŸ”§ æ¥å£ä¿®æ”¹

### 1. MarketDataæ¥å£ç®€åŒ–

```typescript
// ä¿®æ”¹å‰ - å†—ä½™çš„æµåŠ¨æ€§å­—æ®µ
export interface MarketData {
    // ... å…¶ä»–å­—æ®µä¿æŒä¸å˜
    
    // æµåŠ¨æ€§ç›¸å…³ - å­˜åœ¨åŠŸèƒ½é‡å 
    inRangePercentage: number;    // åˆ é™¤
    liquidityHealth: number;      // åˆ é™¤
    activeBinDistance: number;    // åˆ é™¤
    
    // ... å…¶ä»–å­—æ®µ
}

// ä¿®æ”¹å - ç®€åŒ–ä¸ºæ ¸å¿ƒæ•°æ®
export interface MarketData {
    // ä»·æ ¼ç›¸å…³
    currentPrice: number;
    priceHistory: PricePoint[];
    priceVolatility: number;
    priceDropPercentage: number;

    // æ”¶ç›Šç›¸å…³
    totalReturn: number;
    yieldRate: number;
    yieldTrend: 'increasing' | 'decreasing' | 'stable';
    yieldGrowthRate: number;

    // å¤´å¯¸ç›¸å…³
    positionValue: number;
    initialInvestment: number;
    netPnL: number;
    netPnLPercentage: number;

    // æµåŠ¨æ€§ç›¸å…³ - ç®€åŒ–ä¸ºæ ¸å¿ƒbinæ•°æ®
    activeBin: number;           // å½“å‰æ´»è·ƒbin
    positionLowerBin: number;    // è¿é”å¤´å¯¸ä¸‹è¾¹ç•Œ
    positionUpperBin: number;    // è¿é”å¤´å¯¸ä¸Šè¾¹ç•Œ

    // æ—¶é—´ç›¸å…³
    holdingDuration: number;
    lastUpdateTime: number;
}
```

### 2. é…ç½®æ¥å£è°ƒæ•´

```typescript
// SmartStopLossConfigä¸­çš„ç›¸å…³é…ç½®è°ƒæ•´
export interface SmartStopLossConfig {
    // ... å…¶ä»–é…ç½®ä¿æŒä¸å˜
    
    stopLossConditions: {
        maxPriceDropPercentage: number;
        maxVolatilityThreshold: number;
        minYieldGrowthRate: number;
        // minLiquidityHealth: number;        // åˆ é™¤ï¼Œä¸å†éœ€è¦
        maxHoldingDuration: number;
        
        // æ–°å¢ï¼šåŸºäºbinä½ç½®çš„é£é™©é˜ˆå€¼
        maxBelowRangeBins: number;           // æœ€å¤§å…è®¸å‘ä¸‹è„±ç¦»çš„binæ•°é‡
        criticalBelowRangeBins: number;      // è§¦å‘ç´§æ€¥æ­¢æŸçš„å‘ä¸‹è„±ç¦»binæ•°é‡
    };
}
```

## ğŸ§® æ ¸å¿ƒé€»è¾‘é‡æ„

### 1. æµåŠ¨æ€§é£é™©è®¡ç®—é€»è¾‘

```typescript
/**
 * ğŸ’§ è®¡ç®—æµåŠ¨æ€§é£é™© - åŸºäºbinä½ç½®çš„ç²¾ç¡®è®¡ç®—
 */
private calculateLiquidityRisk(marketData: MarketData): number {
    const { activeBin, positionLowerBin, positionUpperBin } = marketData;
    
    // è®¡ç®—ä½ç½®çŠ¶æ€
    if (activeBin < positionLowerBin) {
        // å‘ä¸‹è„±ç¦»ï¼šé«˜é£é™©åŒºåŸŸ
        const belowDistance = positionLowerBin - activeBin;
        return Math.min(100, 80 + belowDistance * 5); // 80-100åˆ†é«˜é£é™©
        
    } else if (activeBin > positionUpperBin) {
        // å‘ä¸Šè„±ç¦»ï¼šä½é£é™©ï¼ˆæ— æŸå¤±ï¼Œç­‰å¾…è°ƒæ•´ï¼‰
        return 20; // å›ºå®š20åˆ†ä½é£é™©
        
    } else {
        // åœ¨138ä¸ªbinèŒƒå›´å†…ï¼šåŸºäºè·ç¦»ä¸‹è¾¹ç•Œè¯„ä¼°é£é™©
        const distanceFromLower = activeBin - positionLowerBin;
        const totalRange = positionUpperBin - positionLowerBin + 1; // 138
        
        // è·ç¦»ä¸‹è¾¹ç•Œè¶Šè¿‘ï¼Œé£é™©è¶Šé«˜
        const riskRatio = 1 - (distanceFromLower / totalRange);
        return Math.max(0, riskRatio * 40); // 0-40åˆ†é£é™©
    }
}
```

### 2. æ­¢æŸæ¡ä»¶è¯„ä¼°é€»è¾‘

```typescript
/**
 * ğŸš¨ è¯„ä¼°æ­¢æŸæ¡ä»¶ - åŒ…å«åŸºäºbinä½ç½®çš„æ¡ä»¶
 */
private evaluateStopLossConditions(marketData: MarketData, riskAssessment: RiskAssessment): boolean {
    const { stopLossConditions } = this.config;
    const { activeBin, positionLowerBin, positionUpperBin } = marketData;
    
    // è®¡ç®—binä½ç½®çŠ¶æ€
    const belowRangeBins = activeBin < positionLowerBin ? positionLowerBin - activeBin : 0;
    
    // æ£€æŸ¥å„ç§æ­¢æŸæ¡ä»¶
    const conditions = [
        // åŸæœ‰æ¡ä»¶
        Math.abs(marketData.priceDropPercentage) > stopLossConditions.maxPriceDropPercentage,
        marketData.priceVolatility > stopLossConditions.maxVolatilityThreshold,
        marketData.yieldGrowthRate < stopLossConditions.minYieldGrowthRate,
        marketData.holdingDuration > stopLossConditions.maxHoldingDuration,
        riskAssessment.overallRisk > this.config.riskThreshold,
        marketData.netPnLPercentage < -this.config.maxLossPercentage,
        
        // æ–°å¢ï¼šåŸºäºbinä½ç½®çš„æ¡ä»¶
        belowRangeBins > stopLossConditions.maxBelowRangeBins,           // å‘ä¸‹è„±ç¦»è¶…è¿‡é˜ˆå€¼
        belowRangeBins > stopLossConditions.criticalBelowRangeBins       // å‘ä¸‹è„±ç¦»è¾¾åˆ°ç´§æ€¥é˜ˆå€¼
    ];

    return conditions.some(condition => condition);
}
```

### 3. è¯¦ç»†æ¨ç†è¯´æ˜å¢å¼º

```typescript
/**
 * ğŸ“ æ·»åŠ è¯¦ç»†çš„æ¨ç†è¯´æ˜ - åŒ…å«binä½ç½®åˆ†æ
 */
private addDetailedReasoning(
    reasoning: string[],
    riskAssessment: RiskAssessment,
    marketData: MarketData
): void {
    const { activeBin, positionLowerBin, positionUpperBin } = marketData;
    
    // åŸæœ‰çš„é£é™©è¯´æ˜...
    
    // æ–°å¢ï¼šæµåŠ¨æ€§ä½ç½®åˆ†æ
    if (activeBin < positionLowerBin) {
        const belowDistance = positionLowerBin - activeBin;
        reasoning.push(`å¤´å¯¸å‘ä¸‹è„±ç¦»: æ´»è·ƒbin ${activeBin} ä½äºä¸‹è¾¹ç•Œ ${positionLowerBin}ï¼Œè„±ç¦»${belowDistance}ä¸ªbinï¼Œå­˜åœ¨äºæŸé£é™©`);
    } else if (activeBin > positionUpperBin) {
        const aboveDistance = activeBin - positionUpperBin;
        reasoning.push(`å¤´å¯¸å‘ä¸Šè„±ç¦»: æ´»è·ƒbin ${activeBin} é«˜äºä¸Šè¾¹ç•Œ ${positionUpperBin}ï¼Œè„±ç¦»${aboveDistance}ä¸ªbinï¼Œæš‚æ—¶æ— æ³•èµšå–æ‰‹ç»­è´¹ä½†æ— æŸå¤±é£é™©`);
    } else {
        const distanceFromLower = activeBin - positionLowerBin;
        const totalRange = positionUpperBin - positionLowerBin + 1;
        reasoning.push(`å¤´å¯¸åœ¨èŒƒå›´å†…: æ´»è·ƒbin ${activeBin} åœ¨[${positionLowerBin}, ${positionUpperBin}]èŒƒå›´å†…ï¼Œè·ç¦»ä¸‹è¾¹ç•Œ${distanceFromLower}ä¸ªbin (${totalRange}ä¸ªbinæ€»èŒƒå›´)`);
    }
}
```

## ğŸ”„ æ•°æ®æä¾›è€…ä¿®æ”¹

### 1. UnifiedDataProviderç®€åŒ–

```typescript
/**
 * è½¬æ¢ä¸ºæ™ºèƒ½æ­¢æŸæ¨¡å—æ‰€éœ€çš„æ•°æ®æ ¼å¼ - ç®€åŒ–ç‰ˆæœ¬
 */
transformToSmartStopLossData(
    data: UnifiedMarketData,
    binData: {
        activeBin: number;
        positionLowerBin: number;
        positionUpperBin: number;
    }
): MarketData {
    const holdingDuration = this.calculateHoldingDuration();
    const yieldGrowthRate = this.calculateYieldGrowthRate(data.yieldHistory);
    const yieldTrend = this.determineYieldTrend(data.yieldHistory);
    const netPnL = parseFloat(data.totalExtractedYield) + parseFloat(data.currentPendingYield) + parseFloat(data.totalPositionValue) - parseFloat(data.initialInvestment);
    const netPnLPercentage = (netPnL / parseFloat(data.initialInvestment)) * 100;

    return {
        // ä»·æ ¼ç›¸å…³
        currentPrice: data.currentPrice,
        priceHistory: data.priceHistory,
        priceVolatility: data.priceVolatility,
        priceDropPercentage: data.priceDropPercentage,

        // æ”¶ç›Šç›¸å…³
        totalReturn: netPnL,
        yieldRate: yieldGrowthRate,
        yieldTrend,
        yieldGrowthRate,

        // å¤´å¯¸ç›¸å…³
        positionValue: parseFloat(data.totalPositionValue),
        initialInvestment: parseFloat(data.initialInvestment),
        netPnL,
        netPnLPercentage,

        // æµåŠ¨æ€§ç›¸å…³ - ç®€åŒ–ä¸ºæ ¸å¿ƒbinæ•°æ®
        activeBin: binData.activeBin,
        positionLowerBin: binData.positionLowerBin,
        positionUpperBin: binData.positionUpperBin,

        // æ—¶é—´ç›¸å…³
        holdingDuration,
        lastUpdateTime: data.timestamp
    };
}
```

### 2. ChainPositionExecutorä¿®æ”¹

```typescript
/**
 * ğŸ“ˆ æ”¶é›†å¸‚åœºæ•°æ® - æä¾›binä½ç½®æ•°æ®
 */
private async collectMarketData(instanceId: string): Promise<MarketData> {
    const state = this.instanceStates.get(instanceId);
    const logger = this.getInstanceLogger(instanceId);
    if (!state) throw new Error('ç­–ç•¥çŠ¶æ€ä¸å­˜åœ¨');

    try {
        // è·å–PositionAnalyticsServiceçš„æ ‡å‡†åŒ–æ•°æ®
        const analyticsService = this.getOrCreatePositionAnalyticsService(instanceId);
        const baseData = await analyticsService.getCachedData();
        
        if (!baseData) {
            throw new Error('æ— æ³•è·å–åˆ†ææœåŠ¡æ•°æ®');
        }

        // å‡†å¤‡binä½ç½®æ•°æ®
        const binData = {
            activeBin: state.currentActiveBin || 0,
            positionLowerBin: state.positionRange ? state.positionRange[0] : 0,
            positionUpperBin: state.positionRange ? state.positionRange[1] : 0
        };

        // ä½¿ç”¨ç®€åŒ–çš„è½¬æ¢æ–¹æ³•
        const marketData = this.unifiedDataProvider.transformToSmartStopLossData(baseData, binData);

        // è®°å½•binä½ç½®çŠ¶æ€
        await logger?.logMonitoring('ğŸ“Š binä½ç½®çŠ¶æ€', {
            æ´»è·ƒbin: binData.activeBin,
            å¤´å¯¸èŒƒå›´: `[${binData.positionLowerBin}, ${binData.positionUpperBin}]`,
            æ€»binæ•°é‡: binData.positionUpperBin - binData.positionLowerBin + 1,
            ä½ç½®çŠ¶æ€: binData.activeBin < binData.positionLowerBin ? 'å‘ä¸‹è„±ç¦»' :
                     binData.activeBin > binData.positionUpperBin ? 'å‘ä¸Šè„±ç¦»' : 'èŒƒå›´å†…',
            è·ç¦»ä¸‹è¾¹ç•Œ: Math.max(0, binData.activeBin - binData.positionLowerBin)
        });

        return marketData;
    } catch (error) {
        await logger?.logError(`å¸‚åœºæ•°æ®æ”¶é›†å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`);
        throw error;
    }
}
```

## ğŸ“Š é…ç½®æ›´æ–°

### é»˜è®¤é…ç½®è°ƒæ•´

```typescript
private static readonly DEFAULT_CONFIG: SmartStopLossConfig = {
    riskThreshold: 70,
    confidenceThreshold: 80,
    maxLossPercentage: 20,
    evaluationInterval: 60,

    riskFactors: {
        priceDropWeight: 0.3,
        volatilityWeight: 0.2,
        yieldDeclineWeight: 0.2,
        liquidityHealthWeight: 0.15, // ä¿æŒæƒé‡ï¼Œä½†è®¡ç®—é€»è¾‘ç®€åŒ–
        timeFactorWeight: 0.15
    },

    stopLossConditions: {
        maxPriceDropPercentage: 15,
        maxVolatilityThreshold: 30,
        minYieldGrowthRate: -10,
        maxHoldingDuration: 24,
        
        // æ–°å¢ï¼šbinä½ç½®ç›¸å…³é˜ˆå€¼
        maxBelowRangeBins: 10,        // æœ€å¤§å…è®¸å‘ä¸‹è„±ç¦»10ä¸ªbin
        criticalBelowRangeBins: 20    // å‘ä¸‹è„±ç¦»20ä¸ªbinè§¦å‘ç´§æ€¥æ­¢æŸ
    }
};
```

## âœ… å®æ–½æ­¥éª¤

### ç¬¬1æ­¥ï¼šä¿®æ”¹æ¥å£å®šä¹‰
1. æ›´æ–°`MarketData`æ¥å£ï¼Œç§»é™¤3ä¸ªé‡å å­—æ®µ
2. æ·»åŠ 3ä¸ªæ ¸å¿ƒbinä½ç½®å­—æ®µ
3. æ›´æ–°`SmartStopLossConfig`æ¥å£

### ç¬¬2æ­¥ï¼šé‡æ„è®¡ç®—é€»è¾‘
1. é‡å†™`calculateLiquidityRisk()`æ–¹æ³•
2. æ›´æ–°`evaluateStopLossConditions()`æ–¹æ³•
3. å¢å¼º`addDetailedReasoning()`æ–¹æ³•

### ç¬¬3æ­¥ï¼šä¿®æ”¹æ•°æ®æä¾›è€…
1. ç®€åŒ–`UnifiedDataProvider.transformToSmartStopLossData()`
2. æ›´æ–°`ChainPositionExecutor.collectMarketData()`
3. ç¡®ä¿binä½ç½®æ•°æ®æ­£ç¡®ä¼ é€’

### ç¬¬4æ­¥ï¼šæµ‹è¯•éªŒè¯
1. æ›´æ–°ç°æœ‰æµ‹è¯•ç”¨ä¾‹
2. éªŒè¯binä½ç½®è®¡ç®—é€»è¾‘
3. æµ‹è¯•å„ç§è„±ç¦»åœºæ™¯çš„é£é™©è¯„ä¼°

## ğŸ¯ é¢„æœŸæ•ˆæœ

1. **æ¶ˆé™¤é‡å **: 3ä¸ªåŠŸèƒ½é‡å çš„å­—æ®µç®€åŒ–ä¸º3ä¸ªæ ¸å¿ƒå­—æ®µ
2. **é€»è¾‘æ¸…æ™°**: ç›´æ¥åŸºäºbinä½ç½®è¿›è¡Œé£é™©è¯„ä¼°
3. **ç²¾ç¡®æ§åˆ¶**: å¯ä»¥ç²¾ç¡®è®¾ç½®å‘ä¸‹è„±ç¦»çš„é£é™©é˜ˆå€¼
4. **æ˜“äºç†è§£**: å¼€å‘è€…å¯ä»¥ç›´è§‚ç†è§£binä½ç½®å…³ç³»
5. **ç»´æŠ¤ç®€å•**: å‡å°‘å¤æ‚çš„ä¸­é—´è®¡ç®—é€»è¾‘

## ğŸ“‹ æ³¨æ„äº‹é¡¹

1. éœ€è¦ç¡®ä¿`ChainPositionExecutor`ä¸­çš„`state.positionRange`æ•°æ®å‡†ç¡®
2. æ´»è·ƒbinæ•°æ®éœ€è¦å®æ—¶æ›´æ–°
3. æµ‹è¯•ç”¨ä¾‹éœ€è¦ç›¸åº”è°ƒæ•´
4. æ–‡æ¡£éœ€è¦æ›´æ–°ä»¥åæ˜ æ–°çš„å­—æ®µå«ä¹‰ 