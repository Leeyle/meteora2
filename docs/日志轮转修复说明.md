# 日志轮转修复说明

## 问题描述

用户发现程序运行很长时间后，日志轮转没有正确执行：
- `api-server.log` 文件是空的（应该显示最新的日志信息）
- `api-server.log.1` 文件保存了旧的日志信息
- 终端打印的信息轮转功能失效

## 根本原因分析

### 原始问题
1. **启动方式问题**：`quick-start.sh` 使用 `nohup npm run dev:api > logs/api-server.log 2>&1 &` 启动服务
2. **轮转方式问题**：`log-rotator.sh` 使用传统的"移动文件"方式进行轮转
3. **文件描述符问题**：当轮转脚本移动 `api-server.log` 到 `api-server.log.1` 时，Node.js进程仍然持有旧文件的文件描述符
4. **结果**：新创建的 `api-server.log` 文件为空，所有新的日志仍然写入到已被移动的文件中

### 技术细节
```bash
# 问题流程：
1. 进程启动：npm run dev:api > logs/api-server.log 2>&1
2. 进程获得文件描述符：fd=3 -> logs/api-server.log
3. 轮转脚本执行：mv logs/api-server.log logs/api-server.log.1
4. 轮转脚本创建：touch logs/api-server.log  # 新文件
5. 问题：进程仍然写入 fd=3，但 fd=3 现在指向 logs/api-server.log.1
6. 结果：新的 logs/api-server.log 为空，所有输出仍在 logs/api-server.log.1
```

## 修复方案

### 1. 改进启动脚本 (`quick-start.sh`)

**修复前**：
```bash
# 直接重定向，文件描述符固定
nohup npm run dev:api > logs/api-server.log 2>&1 &
```

**修复后**：
```bash
# 使用追加模式和包装脚本，支持重启
cat > .start-api.sh << 'EOF'
#!/bin/bash
while true; do
    npm run dev:api >> logs/api-server.log 2>&1
    echo "$(date): API服务器意外退出，3秒后重启..." >> logs/api-server.log
    sleep 3
done
EOF
chmod +x .start-api.sh
nohup bash .start-api.sh &
```

**改进点**：
- 使用 `>>` 追加模式而不是 `>` 重定向模式
- 添加重启机制，提高服务可靠性
- 初始化日志文件，确保文件存在

### 2. 改进轮转脚本 (`log-rotator.sh`)

**修复前**：
```bash
# 传统方式：移动文件
mv "$file_path" "$backup_file"
touch "$file_path"
```

**修复后**：
```bash
# 新方式：复制+截断
cp "$file_path" "$backup_file"    # 复制内容到备份
> "$file_path"                    # 截断原文件（保持文件描述符）
```

**关键优势**：
- **保持文件描述符**：原文件inode不变，进程的文件描述符仍然有效
- **无需重启进程**：进程可以继续正常写入
- **原子操作**：截断操作是原子的，不会丢失日志

### 3. 简化复杂逻辑

**移除不必要的功能**：
- 删除了复杂的进程重启逻辑
- 删除了信号处理机制
- 删除了进程验证功能

**原因**：新的截断方式不需要这些复杂的处理。

## 修复效果验证

### 测试脚本
创建了 `test/log-rotation-fix-test.js` 来验证修复效果：

```javascript
// 测试新轮转方式
async function testNewRotation() {
    // 1. 创建日志文件并写入数据
    // 2. 执行复制+截断轮转
    // 3. 验证原文件被截断，备份文件保存了原内容
    // 4. 继续写入，验证新数据进入原文件
}
```

### 预期结果
- ✅ `api-server.log` 显示最新的日志信息
- ✅ `api-server.log.1` 保存轮转后的旧日志
- ✅ 进程无需重启，日志写入持续正常
- ✅ 日志轮转守护进程正常工作

## 使用说明

### 启动系统
```bash
./scripts/quick-start.sh
```

### 停止系统
```bash
./scripts/quick-stop.sh
```

### 手动执行日志轮转
```bash
./scripts/log-rotator.sh
```

### 验证修复
```bash
node test/log-rotation-fix-test.js
```

## 配置参数

### 轮转配置 (`log-rotator.sh`)
```bash
MAX_SIZE_MB=2              # 最大文件大小(MB)
MAX_FILES=3                # 最大保留文件数
LOG_DIR="./logs"           # 日志目录
```

### 轮转文件列表
```bash
LOG_FILES=(
    "api-server.log"
    "web-server.log"
    "monitor-server.log"
)
```

## 技术优势

1. **零停机轮转**：无需重启进程
2. **数据完整性**：不会丢失日志数据
3. **简单可靠**：减少了复杂的错误处理逻辑
4. **跨平台兼容**：适用于不同的Unix系统
5. **自动化**：通过守护进程定期执行

## 故障排除

### 常见问题

**Q: 轮转后日志仍然为空？**
A: 检查进程是否使用了正确的启动脚本，确保使用追加模式 `>>`

**Q: 轮转脚本执行失败？**
A: 检查文件权限，确保脚本有执行权限：`chmod +x scripts/log-rotator.sh`

**Q: 日志文件过大？**
A: 调整 `MAX_SIZE_MB` 参数，或手动执行轮转

### 调试命令
```bash
# 检查进程状态
ps aux | grep npm

# 检查文件描述符
lsof -p <PID> | grep log

# 检查日志文件
ls -la logs/

# 测试轮转
./scripts/log-rotator.sh
```

## 总结

通过改进启动方式和轮转机制，成功解决了日志轮转问题：
- 使用"复制+截断"替代"移动文件"
- 使用追加模式替代重定向模式
- 简化了复杂的进程管理逻辑

现在系统的日志轮转功能能够正常工作，确保 `api-server.log` 始终显示最新的日志信息。 