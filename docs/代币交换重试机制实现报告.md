# ğŸ”„ ä»£å¸äº¤æ¢é‡è¯•æœºåˆ¶å®ç°æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œæˆ‘ä»¬ä¸ºå–å‡ºä»£å¸æ“ä½œæ·»åŠ äº†é‡è¯•é€»è¾‘ï¼Œå°†æå–æ”¶ç›Šå’Œå–å‡ºä»£å¸æ“ä½œæ˜ç¡®åŒºåˆ†å¼€æ¥ã€‚æå–æ”¶ç›Šæ“ä½œæš‚ä¸å®ç°é‡è¯•æœºåˆ¶ï¼Œè€Œå–å‡ºä»£å¸æ“ä½œä½¿ç”¨ç°æœ‰çš„ `SynchronousRetryManager` é‡è¯•æ¨¡å—å®ç°äº†å®Œæ•´çš„é‡è¯•åŠŸèƒ½ã€‚

## ğŸ¯ å®ç°ç›®æ ‡

1. **åŠŸèƒ½åˆ†ç¦»**: å°†æå–æ”¶ç›Šå’Œå–å‡ºä»£å¸æ“ä½œåŒºåˆ†ä¸ºç‹¬ç«‹åŠŸèƒ½
2. **é‡è¯•æœºåˆ¶**: ä¸ºå–å‡ºä»£å¸æ“ä½œæ·»åŠ æ™ºèƒ½é‡è¯•é€»è¾‘
3. **æ¶æ„æ¸…æ™°**: ä¿æŒç°æœ‰æ¶æ„çš„æ¸…æ™°æ€§å’Œå¯ç»´æŠ¤æ€§
4. **é”™è¯¯å¤„ç†**: æä¾›å®Œå–„çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†æœºåˆ¶

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. **é‡è¯•é…ç½®æ·»åŠ **

åœ¨ `SynchronousRetryManager.ts` ä¸­æ–°å¢äº† `token.swap` é‡è¯•é…ç½®ï¼š

```typescript
'token.swap': {
    maxAttempts: 3,
    retryableErrors: [
        'äº¤æ˜“éªŒè¯è¶…æ—¶', 'äº¤æ˜“å¤±è´¥', 'RPC_ERROR', 'NETWORK_ERROR', 
        'SLIPPAGE_ERROR', 'PRICE_IMPACT_TOO_HIGH', 'Jupiter APIè¯·æ±‚é¢‘ç‡é™åˆ¶',
        'Jupiter APIé”™è¯¯', 'æ‰¾ä¸åˆ°äº¤æ¢è·¯ç”±', 'äº¤æ¢å¤±è´¥', 'ä»£å¸äº¤æ¢å¤±è´¥',
        'insufficient funds', 'slippage tolerance exceeded', 'price impact too high'
    ],
    delayMs: 1500 // 1.5ç§’åŒæ­¥å»¶è¿Ÿ
}
```

**é…ç½®ç‰¹ç‚¹:**
- **æœ€å¤§é‡è¯•æ¬¡æ•°**: 3æ¬¡
- **é‡è¯•å»¶è¿Ÿ**: 1.5ç§’
- **è¦†ç›–é”™è¯¯ç±»å‹**: 14ç§å¸¸è§çš„äº¤æ¢é”™è¯¯

### 2. **YieldOperator é‡æ„**

#### **ä¾èµ–æ³¨å…¥æ›´æ–°**

```typescript
constructor(
    @inject(TYPES.LoggerService) private loggerService: ILoggerService,
    @inject(TYPES.PositionFeeHarvester) private feeHarvester: IPositionFeeHarvester,
    @inject(TYPES.JupiterService) private jupiterService: IJupiterService,
    @inject(TYPES.WalletService) private walletService: IWalletService,
    @inject(TYPES.MeteoraService) private meteoraService: IMeteoraService,
    @inject(TYPES.PositionManager) private positionManager: IPositionManager,
    @inject(TYPES.SynchronousRetryManager) private retryManager: SynchronousRetryManager, // ğŸ”¥ æ–°å¢
    private accumulatedYieldManager: AccumulatedYieldManager
) { }
```

#### **æ–¹æ³•åˆ†ç¦»ä¸é‡æ„**

**1. æ–°å¢å¸¦é‡è¯•çš„äº¤æ¢æ–¹æ³•:**

```typescript
private async swapTokenXToYWithRetry(
    tokenXAmount: string, 
    poolAddress: string, 
    instanceId: string
): Promise<{ outputAmount: string }> {
    return await this.retryManager.executeAsyncWithRetry<{ outputAmount: string }>(
        {
            execute: async () => {
                return await this.swapTokenXToY(tokenXAmount, poolAddress);
            },
            validate: (result) => {
                return result && 
                       typeof result.outputAmount === 'string' && 
                       parseFloat(result.outputAmount) > 0;
            }
        },
        'token.swap',
        instanceId,
        {
            maxAttempts: 3,
            delayMs: 1500
        }
    );
}
```

**2. ä¿ç•™æ ¸å¿ƒäº¤æ¢é€»è¾‘:**

```typescript
private async swapTokenXToY(tokenXAmount: string, poolAddress: string): Promise<{ outputAmount: string }> {
    // åŸæœ‰çš„æ ¸å¿ƒäº¤æ¢é€»è¾‘ï¼Œä¸“æ³¨äºå•æ¬¡äº¤æ¢æ“ä½œ
}
```

**3. ä¸šåŠ¡æµç¨‹æ›´æ–°:**

```typescript
// ğŸ”„ å°†Xä»£å¸é€šè¿‡Jupiteräº¤æ¢ä¸ºYä»£å¸ï¼ˆä½¿ç”¨é‡è¯•æœºåˆ¶ï¼‰
if (parseFloat(poolResult.harvestedFees.tokenX) > 0) {
    await this.loggerService.logSystem('INFO', 
        `ğŸ’° å¼€å§‹å–å‡ºXä»£å¸: ${poolResult.harvestedFees.tokenX} (æ± å­: ${poolAddress.substring(0, 8)}...)`
    );
    
    const swapResult = await this.swapTokenXToYWithRetry(
        poolResult.harvestedFees.tokenX, 
        poolAddress,
        `pool_${poolAddress.substring(0, 8)}_${Date.now()}`
    );
    poolExtractedY = this.addBigNumbers(poolExtractedY, swapResult.outputAmount);
    
    await this.loggerService.logSystem('INFO', 
        `âœ… Xä»£å¸å–å‡ºæˆåŠŸ: ${poolResult.harvestedFees.tokenX} â†’ ${swapResult.outputAmount} Yä»£å¸`
    );
}
```

## ğŸ“Š åŠŸèƒ½éªŒè¯

### **æµ‹è¯•ç»“æœ**

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬ `test/token-swap-retry-test.js`ï¼ŒéªŒè¯äº†ä»¥ä¸‹5ä¸ªå…³é”®åœºæ™¯ï¼š

#### âœ… **æµ‹è¯•1: é‡è¯•é…ç½®éªŒè¯**
- é…ç½®æ­£ç¡®åŠ è½½
- æœ€å¤§é‡è¯•æ¬¡æ•°: 3
- é‡è¯•å»¶è¿Ÿ: 1500ms
- å¯é‡è¯•é”™è¯¯: 14ç§

#### âœ… **æµ‹è¯•2: æˆåŠŸæ“ä½œéªŒè¯**
- å•æ¬¡æˆåŠŸæ‰§è¡Œ
- æ— éœ€é‡è¯•
- ç»“æœéªŒè¯é€šè¿‡

#### âœ… **æµ‹è¯•3: å¤±è´¥é‡è¯•éªŒè¯**
- ç¬¬1æ¬¡å¤±è´¥: `Jupiter APIè¯·æ±‚é¢‘ç‡é™åˆ¶`
- ç­‰å¾…1.5ç§’åé‡è¯•
- ç¬¬2æ¬¡æˆåŠŸ
- æ€»è€—æ—¶: 1601ms

#### âœ… **æµ‹è¯•4: æœ€ç»ˆå¤±è´¥éªŒè¯**
- è¿ç»­3æ¬¡å¤±è´¥
- æ¯æ¬¡é—´éš”1.5ç§’
- æ­£ç¡®æŠ›å‡ºæœ€ç»ˆé”™è¯¯
- æ€»è€—æ—¶: 3001ms

#### âœ… **æµ‹è¯•5: ä¸å¯é‡è¯•é”™è¯¯éªŒè¯**
- é‡åˆ° `é’±åŒ…æœªè§£é”` é”™è¯¯
- ç«‹å³åœæ­¢é‡è¯•
- ä»…å°è¯•1æ¬¡
- æ­£ç¡®é”™è¯¯åˆ†ç±»

## ğŸš€ æ¶æ„ä¼˜åŠ¿

### **1. èŒè´£åˆ†ç¦»**
- **æå–æ”¶ç›Š**: `PositionFeeHarvester` ä¸“æ³¨é“¾ä¸Šæ”¶ç›Šæå–
- **å–å‡ºä»£å¸**: `YieldOperator` è´Ÿè´£ä¸šåŠ¡æµç¨‹ç¼–æ’å’Œé‡è¯•
- **é‡è¯•ç®¡ç†**: `SynchronousRetryManager` æä¾›ç»Ÿä¸€é‡è¯•æœåŠ¡

### **2. é”™è¯¯åˆ†ç±»**
- **å¯é‡è¯•é”™è¯¯**: ç½‘ç»œé—®é¢˜ã€APIé™åˆ¶ã€æ»‘ç‚¹é—®é¢˜ç­‰
- **ä¸å¯é‡è¯•é”™è¯¯**: é’±åŒ…æœªè§£é”ã€ä½™é¢ä¸è¶³ç­‰
- **æ™ºèƒ½åˆ¤æ–­**: è‡ªåŠ¨è¯†åˆ«é”™è¯¯ç±»å‹å¹¶å†³å®šæ˜¯å¦é‡è¯•

### **3. é…ç½®çµæ´»**
- **é»˜è®¤é…ç½®**: é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯
- **è‡ªå®šä¹‰é…ç½®**: å¯é’ˆå¯¹ç‰¹å®šæ“ä½œè°ƒæ•´å‚æ•°
- **åŠ¨æ€æ›´æ–°**: æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°

### **4. äº‹ä»¶é©±åŠ¨**
- **é‡è¯•å¼€å§‹**: `sync.retry.started`
- **é‡è¯•å°è¯•**: `sync.retry.attempt`  
- **é‡è¯•æˆåŠŸ**: `sync.retry.success`
- **é‡è¯•å¤±è´¥**: `sync.retry.failed`

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### **é‡è¯•ç»Ÿè®¡**
- æˆåŠŸç‡ç›‘æ§
- å¹³å‡é‡è¯•æ¬¡æ•°
- é”™è¯¯ç±»å‹åˆ†å¸ƒ
- å“åº”æ—¶é—´åˆ†æ

### **æ—¥å¿—è®°å½•**
- è¯¦ç»†çš„é‡è¯•è¿‡ç¨‹æ—¥å¿—
- é”™è¯¯åŸå› è®°å½•
- æ€§èƒ½æŒ‡æ ‡è¿½è¸ª
- ä¸šåŠ¡æ“ä½œè®°å½•

## ğŸ”® æ‰©å±•èƒ½åŠ›

### **1. æ–°å¢é‡è¯•ç­–ç•¥**
å¯ä»¥è½»æ¾ä¸ºå…¶ä»–æ“ä½œæ·»åŠ é‡è¯•æœºåˆ¶ï¼š
```typescript
'yield.extract': {
    maxAttempts: 2,
    retryableErrors: ['äº¤æ˜“éªŒè¯è¶…æ—¶', 'RPC_ERROR'],
    delayMs: 2000
}
```

### **2. åŠ¨æ€è°ƒæ•´**
æ”¯æŒæ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´é‡è¯•å‚æ•°ï¼š
```typescript
retryManager.updateDefaultConfig('token.swap', {
    maxAttempts: 5,
    delayMs: 2000
});
```

### **3. ç»“æœéªŒè¯**
æ”¯æŒè‡ªå®šä¹‰ç»“æœéªŒè¯é€»è¾‘ï¼š
```typescript
validate: (result) => {
    return result.outputAmount && 
           parseFloat(result.outputAmount) >= expectedMinimum;
}
```

## ğŸ“‹ æ€»ç»“

### **âœ… å·²å®ŒæˆåŠŸèƒ½**

1. **ä»£å¸äº¤æ¢é‡è¯•æœºåˆ¶** - å®Œæ•´å®ç°å¹¶æµ‹è¯•é€šè¿‡
2. **åŠŸèƒ½èŒè´£åˆ†ç¦»** - æå–æ”¶ç›Šä¸å–å‡ºä»£å¸ç‹¬ç«‹æ“ä½œ  
3. **é”™è¯¯åˆ†ç±»å¤„ç†** - æ™ºèƒ½è¯†åˆ«å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯
4. **é…ç½®åŒ–ç®¡ç†** - çµæ´»çš„é‡è¯•å‚æ•°é…ç½®
5. **å®Œæ•´æµ‹è¯•è¦†ç›–** - 5ä¸ªå…³é”®åœºæ™¯å…¨é¢éªŒè¯

### **ğŸ¯ æŠ€æœ¯ç‰¹ç‚¹**

- **æ¶æ„æ¸…æ™°**: ä¿æŒç°æœ‰æ¶æ„çš„æ¸…æ™°æ€§
- **æ‰©å±•æ€§å¼º**: æ˜“äºæ·»åŠ æ–°çš„é‡è¯•ç­–ç•¥
- **æ€§èƒ½ä¼˜åŒ–**: æ™ºèƒ½é‡è¯•é¿å…æ— æ•ˆæ“ä½œ
- **ç›‘æ§å®Œå–„**: è¯¦ç»†çš„æ—¥å¿—å’Œäº‹ä»¶è®°å½•

### **ğŸ”§ ä½¿ç”¨æ–¹å¼**

ä»£å¸äº¤æ¢é‡è¯•æœºåˆ¶å·²é›†æˆåˆ°æ”¶ç›Šæå–æµç¨‹ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯ä½¿ç”¨ã€‚å½“Xä»£å¸éœ€è¦äº¤æ¢ä¸ºYä»£å¸æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿äº¤æ¢æ“ä½œçš„å¯é æ€§ã€‚

**æ³¨æ„**: æå–æ”¶ç›Šæ“ä½œæœ¬èº«æš‚ä¸ä½¿ç”¨é‡è¯•æœºåˆ¶ï¼Œä»…å–å‡ºä»£å¸æ“ä½œä½¿ç”¨é‡è¯•ï¼Œç¬¦åˆç”¨æˆ·çš„æ˜ç¡®è¦æ±‚ã€‚ 